import XLSX from 'xlsx';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// 要件定義書Excel作成スクリプト
function generateRequirementsExcel() {
  const wb = XLSX.utils.book_new();

  // シート1: システム概要
  const overview = [
    ['IC-pochipochi-system 要件定義書'],
    [''],
    ['1. システム概要'],
    ['項目', '内容'],
    ['システム名', 'IC-pochipochi-system（ICポチポチシステム）'],
    ['目的', 'Gハウスの規格住宅における内装・外装・設備のアイテム選択と見積作成を効率化するWebシステム'],
    ['対象ユーザー', '管理者（Gハウス側）: admin, coordinator / お客様: エンドユーザー（施主）'],
    [''],
    ['2. ユーザー区分と権限'],
    ['役割', '権限'],
    ['admin', '全機能利用可能（ユーザー管理、マスタ管理、全プロジェクト操作）'],
    ['coordinator（IC担当）', '担当プロジェクトのみ操作可能、確定取消可能'],
    ['user（お客様）', 'アイテム閲覧・選択、見積確認、確定（確定後は変更不可）'],
    [''],
    ['3. 認証方式'],
    ['方式', 'ログイン認証（メールアドレス + パスワード）'],
    ['アクセス', '1プロジェクトに複数のお客様がアクセス可能（夫婦など）'],
  ];
  const ws1 = XLSX.utils.aoa_to_sheet(overview);
  ws1['!cols'] = [{ wch: 25 }, { wch: 80 }];
  XLSX.utils.book_append_sheet(wb, ws1, 'システム概要');

  // シート2: 管理者側機能
  const adminFeatures = [
    ['管理者側機能一覧'],
    [''],
    ['機能カテゴリ', '機能名', '詳細'],
    ['ユーザー管理', 'クライアント管理', 'お客様の追加・編集・削除'],
    ['', '社内ユーザー管理', '社内ユーザーの追加・編集・削除'],
    ['', '役割設定', 'admin / coordinator の設定'],
    ['', '一括アップロード', 'CSV/Excelでのクライアント一括登録'],
    [''],
    ['プロジェクト管理', 'プロジェクトCRUD', '作成・編集・削除'],
    ['', '建物情報設定', '一般情報、仕様、建物詳細、各種申請'],
    ['', '外装・内装・設備設定', '詳細な仕様設定'],
    ['', '担当IC割り当て', 'coordinatorの割り当て'],
    [''],
    ['マスタ管理', '商品（プラン）管理', 'LIFE, LIFE+, HOURS, LACIE, LIFE X など（増減可能）'],
    ['', 'カテゴリ管理', '外装・内装・設備・その他'],
    ['', 'アイテム管理', '品名、品目、品番、注釈、単位、価格、HIT設定、計算式、画像'],
    ['', '部屋管理', '自由に追加・編集可能'],
    [''],
    ['分析ダッシュボード', '閲覧履歴', 'お客様単位の閲覧履歴'],
    ['', '選択統計', '期間別アイテム選択統計（人気ランキング、低選択アイテム）'],
    ['', 'エクスポート', '統計データのExcel出力'],
    [''],
    ['レポート出力', '見積書', 'A4 / Excel / 価格一覧、合計金額（税抜＋消費税）'],
    ['', '仕様書', 'A3 / Excel / 建物情報、選択アイテム、部屋ごと内装仕様（価格なし）、画像付き'],
    ['', 'プレゼン資料', 'A3 / Excel / 建物情報、選択アイテム、部屋ごと内装、会社ロゴ（価格なし）、画像付き'],
    [''],
    ['通知機能', 'プロジェクト作成時', 'お客様にメール通知'],
    ['', 'お客様確定時', '担当ICにメール通知'],
  ];
  const ws2 = XLSX.utils.aoa_to_sheet(adminFeatures);
  ws2['!cols'] = [{ wch: 20 }, { wch: 25 }, { wch: 70 }];
  XLSX.utils.book_append_sheet(wb, ws2, '管理者側機能');

  // シート3: お客様側機能
  const userFeatures = [
    ['お客様側機能一覧'],
    [''],
    ['機能カテゴリ', '機能名', '詳細'],
    ['アイテム閲覧・選択', 'カテゴリ別一覧', '外装・内装・設備・その他のカテゴリ別表示'],
    ['', '商品別表示', '商品（プラン）に応じたアイテム表示'],
    ['', '画像・色表示', '画像・色バリエーション表示（1色につき1画像）'],
    ['', '価格タイプ表示', '標準（0円）/ オプション（追加料金）の表示'],
    ['', 'HIT表示', 'おすすめアイテムの強調表示'],
    [''],
    ['価格計算', 'リアルタイム計算', '価格積み上げ表示'],
    ['', '税計算', '税抜価格で計算、最後に消費税加算'],
    ['', '合計表示', '合計金額の常時表示'],
    ['', '計算式', 'アイテムごとに自由設定可能（単価×数量＋施工費など）'],
    [''],
    ['選択商品の見える化', 'カテゴリ別表示', 'カテゴリ別選択状況'],
    ['', '部屋別内装表示', '床、壁クロス、天井クロス、巾木、その他部材'],
    [''],
    ['見積確認・確定', '一覧確認', '選択内容の一覧確認'],
    ['', '確定', '確定ボタンで確定（確定後はお客様による変更不可）'],
    ['', '確定取消', 'IC担当のみ可能'],
    [''],
    ['ダウンロード', '見積書', 'Excel / A4'],
    ['', '仕様書', 'Excel / A3'],
    ['', 'プレゼン資料', 'Excel / A3'],
  ];
  const ws3 = XLSX.utils.aoa_to_sheet(userFeatures);
  ws3['!cols'] = [{ wch: 20 }, { wch: 20 }, { wch: 70 }];
  XLSX.utils.book_append_sheet(wb, ws3, 'お客様側機能');

  // シート4: アイテム属性
  const itemAttrs = [
    ['アイテム属性定義'],
    [''],
    ['属性名', '説明', '型', '必須', '備考'],
    ['id', 'アイテムID', 'UUID', '○', '自動生成'],
    ['name', '品名', 'string', '○', ''],
    ['category', '品目', 'string', '○', '外装/内装/設備/その他'],
    ['code', '品番', 'string', '', '型番・製品コード'],
    ['note', '注釈', 'string', '', '補足説明'],
    ['unit', '単位', 'enum', '○', '㎡/個/箇所/セット/一式/枚/m/本'],
    ['is_standard', '標準かどうか', 'boolean', '○', 'true=標準（0円）, false=オプション'],
    ['is_hit', 'HITかどうか', 'boolean', '○', 'おすすめ・推奨アイテム'],
    ['formula', '計算式', 'string', '', '単価×数量＋施工費など自由設定'],
    ['is_required', '必須かどうか', 'boolean', '○', '必須カテゴリは固定'],
    ['image_url', 'メイン画像', 'string', '', '画像URL'],
    [''],
    ['色バリエーション'],
    ['属性名', '説明', '型', '必須', '備考'],
    ['color_name', '色名', 'string', '○', ''],
    ['color_image_url', '色別画像', 'string', '○', '1色につき1画像'],
  ];
  const ws4 = XLSX.utils.aoa_to_sheet(itemAttrs);
  ws4['!cols'] = [{ wch: 15 }, { wch: 25 }, { wch: 12 }, { wch: 8 }, { wch: 45 }];
  XLSX.utils.book_append_sheet(wb, ws4, 'アイテム属性');

  // シート5: 出力ドキュメント仕様
  const docSpecs = [
    ['出力ドキュメント仕様'],
    [''],
    ['ドキュメント名', 'サイズ', '形式', '含まれる情報', '価格情報', 'テンプレート'],
    ['見積書', 'A4縦', 'Excel', '表紙（会社情報、日付、お客様情報、合計金額）+ 明細シート（区分、工事内容、数量、単位、見積単価、見積金額、備考）+ カテゴリ別合計', '含む（税抜＋消費税）', '春山様邸お見積フォーマット準拠'],
    ['仕様書', 'A3横', 'Excel', '左側：平面図、右側：部屋別仕様テーブル（床材・壁紙）+ 共通部材テーブル + 商品画像', '含まない', 'DETAIL 1F/2Fフォーマット準拠'],
    ['プレゼン資料', 'A3横', 'Excel', '仕様書と同フォーマット + 会社ロゴ、確定図ラベル、日付', '含まない', '内装プレゼンフォーマット準拠'],
    ['統計データ', '-', 'Excel', '閲覧履歴、選択統計、人気ランキング', '-', '新規作成'],
  ];
  const ws5 = XLSX.utils.aoa_to_sheet(docSpecs);
  ws5['!cols'] = [{ wch: 15 }, { wch: 8 }, { wch: 8 }, { wch: 80 }, { wch: 20 }, { wch: 30 }];
  XLSX.utils.book_append_sheet(wb, ws5, '出力ドキュメント');

  // シート6: 見積書フォーマット詳細
  const estimateFormat = [
    ['見積書フォーマット詳細（A4縦）'],
    [''],
    ['【表紙構成】'],
    ['要素', '内容'],
    ['タイトル', '工事御見積書'],
    ['サブタイトル', '契約後打合せ変更見積'],
    ['お客様情報', '住所・氏名'],
    ['日付', '見積作成日（令和○年○月○日）'],
    ['合計金額', '大きく表示（税込）'],
    ['消費税額', '明記（10%）'],
    ['カテゴリ別小計', '設計変更、設計変更 設備工事、照明・カーテン・エアコン、家具、工事金額'],
    ['会社情報', 'ロゴ、社名、資格情報'],
    [''],
    ['【明細シート構成】'],
    ['列名', '説明'],
    ['商品名', 'ヘッダー左上（LIFE+など）'],
    ['カテゴリ名', 'ヘッダー（設計変更 設備など）'],
    ['日付', 'ヘッダー右（R6.3.22など）'],
    ['区分', '工事区分（軒天工事、サッシ工事など）'],
    ['No.', '連番（任意）'],
    ['工事内容', 'アイテム名・詳細'],
    ['数量', '数値'],
    ['単位', '㎡/カ所/枚/m/式/個/本'],
    ['見積単価', '単価'],
    ['見積金額', '金額（マイナスは▲表示）'],
    ['備考', '製品名、メーカー、補足'],
    [''],
    ['【特記事項】'],
    ['項目', '内容'],
    ['値引き表示', 'プレゼント・クーポンは▲（マイナス）表示'],
    ['カテゴリ別合計', '各シート末尾に表示'],
    ['フッター', '出力日、ページ番号（Page X of Y）'],
  ];
  const ws6 = XLSX.utils.aoa_to_sheet(estimateFormat);
  ws6['!cols'] = [{ wch: 20 }, { wch: 70 }];
  XLSX.utils.book_append_sheet(wb, ws6, '見積書フォーマット');

  // シート7: 仕様書・プレゼンフォーマット詳細
  const specFormat = [
    ['仕様書・プレゼンフォーマット詳細（A3横）'],
    [''],
    ['【全体構成】'],
    ['要素', '位置', '内容'],
    ['タイトル', '左上', 'DETAIL 1F / DETAIL 2F'],
    ['カテゴリ', '左上', '内装'],
    ['物件情報', '右上', '○○市○○・○○ 邸'],
    ['平面図', '左半分', '間取り図（各部屋の配置、寸法、設備位置）'],
    ['仕様テーブル', '右半分', '部屋別内装仕様 + 共通部材'],
    ['確定図ラベル', '右下', '確定図（赤枠）'],
    ['日付', '右下', 'YYYY年 MM月 DD日'],
    [''],
    ['【部屋別内装仕様テーブル】'],
    ['列名', '説明'],
    ['部屋名', '玄関、ホール、LDK、洗面、トイレなど'],
    ['メーカー', 'LIXIL、朝日ウッドテック、田島ルーフィングなど'],
    ['商品名', 'メンフィス、ライブナチュラルMSX-Lなど'],
    ['カラー', 'ドライオーク、目地：M-2など'],
    ['床材画像', 'サムネイル画像'],
    ['クロス（壁）', '品番（SP2533など）'],
    ['クロス（天井）', '品番'],
    ['クロス（アクセント）', '品番（2列）'],
    [''],
    ['【共通部材テーブル】'],
    ['項目', '内容'],
    ['玄関框', 'メーカー、デザイン、カラー'],
    ['窓台', 'メーカー、デザイン、カラー'],
    ['巾木', 'メーカー、デザイン、カラー'],
    ['腰壁笠木', 'メーカー、デザイン、カラー'],
    ['階段/踏板', 'メーカー、デザイン、カラー'],
    ['階段/蹴込', 'メーカー、デザイン、カラー'],
    ['階段笠木', 'メーカー、デザイン、カラー'],
    ['浴室建具枠', 'メーカー、デザイン、カラー'],
    ['階段手摺棒', 'メーカー、デザイン、カラー'],
    ['階段ブラケット', 'メーカー、デザイン、カラー'],
    ['壁付I型手摺ブラケット', 'メーカー、デザイン、カラー'],
    ['ニッチ台', 'メーカー、カラー'],
    ['樹脂可動棚', 'メーカー、カラー'],
    ['可動棚', 'メーカー、カラー'],
    ['造作トイレ収納', 'メーカー'],
    ['床下点検口', 'メーカー、カラー'],
    ['天井点検口', 'メーカー、カラー'],
    ['壁点検口', 'メーカー'],
    ['インテリアカウンター', 'メーカー、タイプ'],
  ];
  const ws7 = XLSX.utils.aoa_to_sheet(specFormat);
  ws7['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 60 }];
  XLSX.utils.book_append_sheet(wb, ws7, '仕様書フォーマット');

  // シート8: 技術スタック
  const techStack = [
    ['技術スタック'],
    [''],
    ['カテゴリ', '技術', 'バージョン/備考'],
    ['フロントエンド', 'React', '19'],
    ['', 'TypeScript', ''],
    ['', 'Vite', 'ビルドツール'],
    ['', 'Tailwind CSS', 'スタイリング'],
    ['', 'Zustand', '状態管理'],
    ['', 'Radix UI', 'UIコンポーネント'],
    [''],
    ['バックエンド', 'Supabase', 'PostgreSQL'],
    ['', 'Supabase Auth', '認証'],
    ['', 'Supabase Storage', '画像管理'],
    [''],
    ['出力', 'xlsx', 'Excel出力'],
    [''],
    ['デプロイ', 'Vercel', 'ホスティング'],
    ['', 'GitHub', 'ソース管理'],
    [''],
    ['対応環境', 'PC', 'Chrome, Edge, Safari, Firefox'],
    ['', 'スマホ・タブレット', 'レスポンシブ対応'],
    [''],
    ['言語', '日本語', '基本的に日本語のみ'],
  ];
  const ws8 = XLSX.utils.aoa_to_sheet(techStack);
  ws8['!cols'] = [{ wch: 15 }, { wch: 20 }, { wch: 40 }];
  XLSX.utils.book_append_sheet(wb, ws8, '技術スタック');

  // シート9: 通知仕様
  const notifSpecs = [
    ['通知仕様'],
    [''],
    ['トリガー', '送信先', '内容'],
    ['プロジェクト作成時', 'お客様', 'ログイン情報、システムURL'],
    ['お客様確定時', '担当IC', '確定通知、プロジェクトリンク'],
  ];
  const ws9 = XLSX.utils.aoa_to_sheet(notifSpecs);
  ws9['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 40 }];
  XLSX.utils.book_append_sheet(wb, ws9, '通知仕様');

  // シート10: 非機能要件
  const nonFunc = [
    ['非機能要件'],
    [''],
    ['カテゴリ', '要件', '詳細'],
    ['対応環境', 'PCブラウザ', 'Chrome, Edge, Safari, Firefox'],
    ['', 'モバイル', 'スマホ・タブレット（レスポンシブ対応）'],
    [''],
    ['言語', '日本語', '基本的に日本語のみ'],
    [''],
    ['セキュリティ', 'ログイン認証', 'メールアドレス＋パスワード'],
    ['', 'アクセス制御', '役割ベースアクセス制御（RBAC）'],
    ['', '通信', 'HTTPS'],
    [''],
    ['データ管理', '変更履歴', '誰がいつ何を変更したか保存'],
    ['', 'バックアップ', '定期バックアップ'],
  ];
  const ws10 = XLSX.utils.aoa_to_sheet(nonFunc);
  ws10['!cols'] = [{ wch: 15 }, { wch: 20 }, { wch: 50 }];
  XLSX.utils.book_append_sheet(wb, ws10, '非機能要件');

  // シート11: 質問回答まとめ
  const qaList = [
    ['要件確認 質問回答まとめ'],
    [''],
    ['#', '項目', '回答'],
    ['1', 'アクセス方法', 'ログイン'],
    ['2', 'プロジェクトへのアクセス', '複数お客様可'],
    ['3', '商品（プラン）', '増減の可能性あり'],
    ['4', 'アイテムと商品の関係', '一部共通、一部異なる'],
    ['5', '見積パターン', '1プロジェクト = 1見積'],
    ['6', '部屋の定義', '管理者が自由に追加・編集可'],
    ['7', 'HIT', 'おすすめ・推奨アイテム'],
    ['8', '仕様書の内容', '建物情報、アイテム一覧（画像付き）、部屋ごと内装'],
    ['9', 'プレゼンの内容', '建物情報、アイテム一覧、部屋ごと内装、会社ロゴ'],
    ['10', '閲覧履歴', 'お客様単位'],
    ['11', '統計エクスポート', 'Excel出力可'],
    ['12', '価格計算', '単価×数量 + 施工費など複雑ロジックあり'],
    ['13', '税込/税抜', '税抜で計算、最後に消費税加算'],
    ['14', '施工費設定', 'アイテムごとに計算式を自由設定'],
    ['15', 'Excelテンプレート', '既存あり'],
    ['16', '社内ユーザー権限', 'admin: 全機能、coordinator: 担当プロジェクトのみ'],
    ['17', '選択確定フロー', '即反映、最後に確定ボタン'],
    ['18', '確定後の変更', 'IC担当は変更・確定取消可、お客様は不可'],
    ['19', '通知機能', 'プロジェクト作成時→お客様、確定時→担当IC'],
    ['20', '利用環境', 'PC + スマホ・タブレット（レスポンシブ）'],
    ['21', '多言語', '日本語のみ'],
    ['22', 'バックアップ・履歴', '変更履歴保存 + 定期バックアップ'],
    ['23', '色別画像', '1色につき1画像'],
    ['24', '必須項目', '一部カテゴリのみ必須'],
    ['25', '必須カテゴリ設定', '固定'],
  ];
  const ws11 = XLSX.utils.aoa_to_sheet(qaList);
  ws11['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 60 }];
  XLSX.utils.book_append_sheet(wb, ws11, '質問回答まとめ');

  // ファイル出力
  const outputPath = path.join(__dirname, '..', 'docs', 'SYSTEM_REQUIREMENTS.xlsx');
  XLSX.writeFile(wb, outputPath);
  console.log(`要件定義書を出力しました: ${outputPath}`);
}

generateRequirementsExcel();
